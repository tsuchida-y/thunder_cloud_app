# 入道雲サーチアプリ

## 背景・目的

- **入道雲を見逃さないために**  
  自分の好きな入道雲が、どの方向で出現しているかを知りたいという思いから開発しました。  
- **自分の好きなもののためにアプリ開発に挑戦**  
  趣味としてのクラウド観察と Flutter を利用して、実用的なアプリ作成に挑戦。

## 機能

- **入道雲の出現方向の表示**  
  現在位置を基準に、東西南北4方向×3距離（50km/160km/250km）の計12地点で積乱雲の発生可能性を分析し、方向別に視覚的に表示します。
- **高度気象分析による精密判定**  
  Open-Meteo APIから以下の専門的な気象データを取得し、積乱雲の可能性を総合的に評価します：
  - **CAPE（対流有効位置エネルギー）**: 対流の強さを示す指標
  - **リフティド指数**: 大気の安定度を示す指標  
  - **CIN（対流抑制）**: 対流の抑制力を示す指標
  - **気温・湿度・気圧**: 基本的な気象要素
- **総合スコア表示**  
  各指標を重み付けした総合スコア（60%以上で積乱雲の可能性あり）を表示します。
- **定期的な天気情報取得**  
  3分間隔（API使用量に応じて自動調整）で定期的にチェックし、新しい積乱雲を検出した場合は即座に通知します。
- **地図表示**  
  現在地や周辺の情報をGoogleMap上に表示し、視覚的に分かりやすくしています。
- **方向ごとのウィジェット配置**  
  各方向の入道雲情報に応じて、画面上に`CloudAvatar`等のウィジェットを動的に配置しています。
- **ローカル通知機能**  
  入道雲が検出された場合、フォアグラウンドで即座にローカル通知を表示します。（iOS/Android対応）



## 積乱雲判定ロジック

### **分析指標と重み配分**
| 指標 | 重み | 説明 | 判定基準 |
|------|------|------|----------|
| CAPE | 50% | 対流有効位置エネルギー | 2500+ J/kg: 100%、1000-2500: 80%、500-1000: 60%、100-500: 30%、100未満: 0% |
| リフティド指数 | 35% | 大気安定度 | -6以下: 100%、-3～-6: 80%、0～-3: 60%、3～0: 40%、6～3: 20%、6以上: 0% |
| CIN | 5% | 対流抑制 | 10以下: 30%、50以下: 10%、50以上: 0% |
| 気温 | 10% | 基本気象要素 | 30°C以上: 100%、25-30°C: 80%、20-25°C: 60%、15-20°C: 40%、15°C未満: 0% |

### **検索範囲設定**
- **距離**: 50km（近距離）、160km（中距離）、250km（遠距離）
- **方向**: 北・南・東・西の4方向
- **総チェック地点**: 12地点（4方向 × 3距離）
- **API使用量**: 約5,760リクエスト/日（制限10,000以下で安全運用）

### **総合判定**
- **60%以上**: 積乱雲の可能性あり
- **60%未満**: 積乱雲の可能性低い
- **信頼度**: データの完整性に基づく信頼度（通常100%）

## ファイル構成

```
thunder_cloud_app/
├── lib/
│   ├── main.dart                          // アプリのエントリーポイント
│   ├── constants/
│   │   ├── avatar_positions.dart          // ウィジェットの配置位置などの定数
│   │   └── weather_constants.dart         // 気象分析の重み係数定数
│   ├── models/
│   │   ├── advanced_weather_data.dart     // 高度気象データモデル
│   │   ├── thunder_cloud_assessment.dart  // 積乱雲評価結果モデル
│   │   └── weather_data.dart              // 基本天気データモデル
│   ├── screens/
│   │   └── weather_screen.dart            // 天気情報表示画面の状態管理
│   ├── services/
│   │   ├── geolocator.dart                // 現在地取得のロジック
│   │   ├── location_service.dart          // 位置情報サービス（Google Maps用型変換）
│   │   ├── notification_service.dart      // ローカル通知機能の実装
│   │   ├── weather_service.dart           // 天気サービス統合インターフェース
│   │   └── weather/
│   │       ├── weather_api.dart           // Open-Meteo API へのリクエスト実装
│   │       ├── advanced_weather_api.dart  // 高度気象データ取得API（削除予定）
│   │       ├── thunder_cloud_analyzer.dart // 積乱雲分析ロジック
│   │       ├── meteorological_calculator.dart // 気象学的計算ユーティリティ
│   │       └── weather_logic.dart         // 入道雲判定ロジック
│   ├── utils/
│   │   ├── api_helper.dart                // API共通ヘルパー
│   │   └── error_handler.dart             // エラーハンドリングユーティリティ
│   └── widgets/
│       ├── cloud_avatar.dart              // 入道雲または青空の画像を表示するウィジェット
│       ├── direction_image.dart           // 画面上に方向を示す画像
│       ├── weather_app_bar.dart           // AppBar専用ウィジェット
│       ├── weather_detail_dialog.dart     // 詳細分析結果表示ダイアログ
│       ├── background_map_widget.dart     // GoogleMap背景表示ウィジェット（旧weather_map_view.dart）
│       └── thunder_cloud_overlay.dart     // 積乱雲情報オーバーレイウィジェット（旧weather_overlay.dart）
```

## 通知機能

### **機能概要**
- **入道雲検出時の自動通知**: 新しい入道雲が検出された方向を即座に通知
- **iOS/Android両対応**: プラットフォーム固有の通知設定に対応
- **フォアグラウンド動作**: アプリ起動中の通知機能（バックグラウンド処理は無効）

### **操作ボタン（開発・テスト用）**
画面右下に5つのFloatingActionButtonが配置されています：

| ボタン色 | アイコン | 機能 | 説明 |
|---------|----------|------|------|
| 🟦 インディゴ | 📊 分析 | 高度分析実行 | Open-Meteoを使用した詳細な積乱雲分析を実行 |

### **通知の種類(テスト段階。要検討)**
- **入道雲発見通知**: 「⛈️ 入道雲を発見！○○方向に入道雲が出現しています」
- **テスト通知**: 「🧪 テスト通知 - ローカル通知が正常に動作しています」



## 工夫した点

- **高度気象分析の実装**
  * Open-Meteo APIを使用した専門的な気象データ（CAPE、LI、CIN）の取得と分析
  * 気象学的根拠に基づく重み付きスコア計算による精密な積乱雲判定
  * 複数の指標を総合した信頼性の高い評価システム

- **位置情報と距離計算**
  * 緯度1度あたりの距離を考慮した正確な方向計算（特に経度は緯度によって距離が変わるため、三角関数を使用）
  * 現在地から約30kmの距離にある各方向のポイントを計算し、最適な天気情報を取得
  * 方向ごとに一般化されたメソッドで、コードの冗長性を削減

- **設計とアーキテクチャ**
  * UI・ロジック・定数・モデルなどの責務ごとにファイルを分割し、保守性と再利用性を向上
  * 例外処理を専用クラスに分離し、エラーハンドリングを統一的に管理
  * ウィジェットの位置情報を定数として外部管理することで、レイアウト調整を容易に

- **ユーザー体験の向上**
  * Timer.periodicを使用した定期的な天気情報更新により、リアルタイムな情報提供を実現
  * GoogleMapと連携した視覚的なインターフェースで方向感覚を分かりやすく表現
  * 気象学的根拠に基づく精密な判定ロジックにより、より正確な検出を実現

- **API効率化**
  * OpenWeatherMap APIを削除し、Open-Meteo APIに一本化することでAPIリクエスト数を削減
  * 実行間隔を60秒に最適化し、API制限内での安定動作を実現

## 使用方法

1. **セットアップ**  
   - ~~プロジェクトルートに `.env` ファイルを作成し、API キーなどの環境変数を設定します。~~（不要になりました）
   - Open-Meteo APIは無料で使用できるため、APIキーの設定は不要です。
   - 必要な依存パッケージをインストールします。
     ```bash
     flutter pub get
     ```

2. **アプリの起動**  
   - `main.dart` をエントリーポイントとして、Flutter アプリを起動します。
     ```bash
     flutter run
     ```

3. **動作確認**  
   - アプリ起動後、現在地が地図上に表示され、60秒ごとに各方向の高度気象分析が実行されます。
   - 総合スコア60%以上の場合、対応する方向のウィジェット（CloudAvatar）が更新されます。

## アプリの動作例

### 高度気象分析を実行した際のログ出力例です：

```
[log] === 積乱雲分析結果（Open-Meteoのみ）===
[log] 総合判定: 積乱雲の可能性低い
[log] 総合スコア: 29.5%
[log] 信頼度: 100.0%
[log] リスクレベル: 低い
[log] north: 積乱雲なし
```

現在の気象条件（岩手県付近）では積乱雲の発生条件が整っていないため、29.5%という適切な低スコアが表示されています。

### アプリを実際に動作させた際のスクリーンショットです。

<table>
  <tr>
    <td><img src="./assets/images/place_permission.png" alt="アプリのメイン画面2" width="300"/></td>
    <td><img src="./assets/images/thunder_cloud.png" alt="アプリのメイン画面1" width="300"/></td>
  </tr>
</table>


## 今後の展望

- **画像保存・共有機能**
    * 入手した入道雲の写真を保存、もしくは SNS などで共有できるようにする。
    * アップするたびにモンスターが成長していくとか
- **拡張機能**  
    * 入道雲以外の雲情報や、柔軟なカスタム描画によるウィジェット表現の導入。
- **UI/UX の改善**  
    * 現在地取得やエラーハンドリングをさらに強化し、ユーザーにとって使いやすいインターフェースを実現する。

## 開発用メモ
- 使用可能なiOSシミュレータ
```
xcrun simctl list devices
```

- シミュレータの起動
```
xcrun simctl boot <UDID>
xcrun simctl boot CD928AEE-F546-4212-A73D-E491C33E041F
```
- シミュレータを開く
```
open -a Simulator
```